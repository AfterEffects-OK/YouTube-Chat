<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚«ã‚¹ã‚¿ãƒ  YouTube Live Chat Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š: æ—¥æœ¬èªã¨è‹±èªã®è¡¨ç¤ºã‚’è€ƒæ…® */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+JP:wght@400;700&display=swap');
        
        /* ----------------------------------------------------- */
        /* â˜…CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤) â˜… */
        /* ----------------------------------------------------- */
        :root {
            /* ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ */
            --global-font-family: 'Noto Sans JP', 'Inter', sans-serif;
            font-family: var(--global-font-family);

            /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®é«˜ã• */
            --pinned-chat-height: 320px;
            
            /* å€‹åˆ¥ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ï¼ˆåˆæœŸå€¤ã¯ç©ºï¼‰ */
            --author-font-family: ;
            --message-font-family: ;

            /* ğŸ’¡ 2è¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®åå‰ã®å·¦ãƒãƒ¼ã‚¸ãƒ³ (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ) */
            --author-indent-rem: 0rem; 
            
            /* ğŸ’¡ 2è¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã®å·¦ãƒãƒ¼ã‚¸ãƒ³ (ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ) */
            --message-indent-rem: 0rem; 

            /* ğŸ’¡ 2è¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®åå‰ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é–“ã®ç¸¦æ–¹å‘ã®ã‚®ãƒ£ãƒƒãƒ— */
            --author-message-gap-rem: 0.2rem;
            
            /* ğŸ’¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã®æœ€å¤§æ–‡å­—æ•° (chå˜ä½) */
            --message-max-chars: 80ch; 
            
            /* ğŸ’¡ ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®å‚ç›´ä½ç½®èª¿æ•´ (pxå˜ä½) */
            --author-vertical-offset-px: 0px; 
            
            /* ãƒ¦ãƒ¼ã‚¶ãƒ¼å (Author) ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ */
            --author-default-color: #fec834; 
            --author-default-size: 1.0rem;
            
            /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ (Message) ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ */
            --message-default-color: #e2e8f0;
            --message-default-size: 1.0rem;

            /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢å°‚ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            --pinned-author-font-family: ;
            --pinned-message-font-family: ;
            --pinned-author-color-override: ;
            --pinned-author-font-size: ;
            --pinned-message-color-override: ;
            --pinned-message-font-size: ;
        }
        
        /* ----------------------------------------------------- */
        /* â˜…å…¨ä½“ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚«ã‚¹ã‚¿ãƒ  (æ¨ªä¸¦ã³) â˜… */
        /* ----------------------------------------------------- */
        
        /* body: å¸¸ã«ç”»é¢ã„ã£ã±ã„ã«åºƒãŒã‚Šã€Flexã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦æ©Ÿèƒ½ */
        body {
            display: flex;
            /* ç”»é¢ãŒç‹­ã„ï¼ˆã‚¹ãƒãƒ›ãªã©ï¼‰ã¨ãã¯ç¸¦ä¸¦ã³ */
            flex-direction: column; 
            min-height: 100vh;
            /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®é«˜ã•åˆ†ã€ä¸‹éƒ¨ã«ä½™ç™½ã‚’ç¢ºä¿ */
            padding-bottom: var(--pinned-chat-height);
        }

        /* mdã‚µã‚¤ã‚ºä»¥ä¸Šã§æ¨ªä¸¦ã³ã«åˆ‡ã‚Šæ›¿ãˆ */
        @media (min-width: 768px) {
            body {
                flex-direction: row;
                height: 100vh; /* å¸¸ã«ç”»é¢ã®é«˜ã•ã„ã£ã±ã„ã‚’ä½¿ã† */
                /* æ¨ªä¸¦ã³ã®ã¨ãã¯bodyã®paddingã¯ä¸è¦ */
                padding-bottom: 0; 
            }
        }
        
        @media (min-width: 768px) {
            #control-panel-container {
                width: 360px; /* å›ºå®šå¹… */
                height: 100vh;
            }
        }
        
        /* â˜…ä¿®æ­£: ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ãƒ©ãƒƒãƒ‘ãƒ¼ (ãƒãƒ£ãƒƒãƒˆ + SCã‚¹ãƒˆãƒƒã‚¯ + ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢) */
        #main-display-wrapper {
            /* mdä»¥ä¸Šã§ã¯æ®‹ã‚Šå…¨ã¦ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ã† */
            flex-grow: 1;
            display: flex;
            flex-direction: column; /* ä¸Šä¸‹ã«è¦ç´ ã‚’é…ç½® */
        }

        /* â˜…æ–°è¦: ãƒãƒ£ãƒƒãƒˆã¨SCã‚¹ãƒˆãƒƒã‚¯ã‚’æ¨ªã«ä¸¦ã¹ã‚‹ãŸã‚ã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
        #chat-and-sc-wrapper {
            flex-grow: 1; /* æ®‹ã‚Šã®é«˜ã•ã‚’ã™ã¹ã¦ä½¿ç”¨ */
            display: flex;
            min-height: 0; /* â˜…è¿½åŠ : flexã‚¢ã‚¤ãƒ†ãƒ ãŒè¦ªã®é«˜ã•ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã™ã‚‹ */
        }
        
        /* ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        #chat-container {
            display: flex;
            /* column-reverseã§æœ€æ–°ã®ãƒãƒ£ãƒƒãƒˆãŒä¸‹éƒ¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ */
            flex-direction: column-reverse; 
            flex-grow: 1; 
            align-items: flex-start; /* â˜…è¿½åŠ : ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å·¦æƒãˆã«ã—ã€å¹…ã‚’å†…å®¹ã«åˆã‚ã›ã‚‹ */
            min-height: 50vh; /* ç‹­ã„ç”»é¢ã§ã®æœ€ä½é«˜ã•ã‚’ç¢ºä¿ */
            overflow-y: auto; /* â˜…ä¿®æ­£: ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«æˆ»ã™ */
            background-color: #1a1a1a; /* ãƒ€ãƒ¼ã‚¯ãªèƒŒæ™¯è‰² */
            padding: 1rem;
            padding-bottom: 3rem; 
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        @media (min-width: 768px) {
            #chat-container {
                /* å¤‰æ›´: ãƒãƒ£ãƒƒãƒˆã¯3/4ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å ã‚ã‚‹ (SCã‚¹ãƒˆãƒƒã‚¯ã¨åˆã‚ã›ã¦) */
                width: 75%; 
                height: auto; /* â˜…ä¿®æ­£: é«˜ã•ã‚’è‡ªå‹•ã« */
                border-radius: 0; /* è§’ä¸¸ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç”»é¢ç«¯ã«åˆã‚ã›ã‚‹ */
                flex-grow: 1; /* â˜…ä¿®æ­£: è¦ªã®é«˜ã•ã«è¿½å¾“ */
            }
        }

        /* â˜…æ–°è¦: ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ */
        #superchat-stock-container {
            display: flex;
            flex-direction: column; /* SCã‚«ãƒ¼ãƒ‰ã‚’ä¸Šã‹ã‚‰ä¸‹ã«ç©ã¿é‡ã­ã‚‹ */
            
            /* ç‹­ã„ç”»é¢ã§ã¯ãƒãƒ£ãƒƒãƒˆã®ä¸‹ã«å…¨å¹… */
            width: 100%;
            min-height: 30vh;
            overflow-y: auto;
            background-color: #0d0d0d; /* éå¸¸ã«ãƒ€ãƒ¼ã‚¯ãªèƒŒæ™¯ */
            border-top: 2px solid #ffaa00;
            
            /* Padding for the list of SCs */
            padding: 0.5rem; 
        }

        @media (min-width: 768px) {
            #superchat-stock-container {
                /* å¤‰æ›´: SCã‚¹ãƒˆãƒƒã‚¯ã¯1/4ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’å ã‚ã‚‹ */
                width: 25%;
                height: auto; /* â˜…ä¿®æ­£: é«˜ã•ã‚’è‡ªå‹•ã« */
                border-top: none;
                border-left: 2px solid #ffaa00; 
                flex-grow: 1; /* â˜…è¿½åŠ : è¦ªã®é«˜ã•ã«è¿½å¾“ã•ã›ã‚‹ */
            }
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºï¼ˆWebkitç³»ï¼‰ */
        #chat-container::-webkit-scrollbar,
        #superchat-stock-container::-webkit-scrollbar {
            display: none;
        }
        
        /* ----------------------------------------------------- */
        /* â˜…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©â˜… */
        /* ----------------------------------------------------- */

        /* æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã¨ãã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ (ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³) */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¹ãƒ†ãƒƒã‚«ãƒ¼/ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆã®å¼·èª¿ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes highlight {
            from { opacity: 0.9; }
            to { opacity: 1; }
        }

        /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚è§£é™¤æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes fadeOutDown {
            from {
                opacity: 1;
                transform: translateY(0);
            }
            to {
                opacity: 0;
                transform: translateY(20px);
            }
        }

        /* å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-message {
            display: flex;
            flex-direction: column;
            padding: 0.5rem; 
            margin-bottom: 0.5rem; 
            border-radius: 6px; 
            transition: all 0.3s ease;
            position: relative; 
            z-index: 10;
            overflow: hidden; 
            background-color: transparent !important; 
            flex-shrink: 0; /* â˜…è¿½åŠ : ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
            
            cursor: pointer; /* â˜…è¿½åŠ : ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */
            max-width: 100%; /* â˜…ä¿®æ­£: width: 100% ã‹ã‚‰å¤‰æ›´ã—ã€å†…å®¹ã«è¿½å¾“ã•ã›ã‚‹ */
            
            /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ */
            animation: fadeIn 0.5s ease-out; 
        }

        /* èƒŒæ™¯ç”»åƒ/èƒŒæ™¯è‰²ã‚’åˆ¶å¾¡ã™ã‚‹ç–‘ä¼¼è¦ç´  */
        .chat-message::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1; 
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover;
            opacity: 1; 
            transition: opacity 0.3s, background-color 0.3s;
        }

        /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èƒŒæ™¯è‰²ï¼ˆç”»åƒãŒãªã„å ´åˆï¼‰ */
        .chat-message:nth-child(even)::before {
            background-color: #2a2a2a; 
        }
        
        .chat-message:nth-child(odd)::before {
            background-color: #242424; 
        }

        /* èƒŒæ™¯ç”»åƒãŒè¨­å®šã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .chat-message[data-bg-image="true"]::before {
            background-image: var(--bg-image-url);
            opacity: 0.7; 
            background-color: #242424; 
            background-blend-mode: multiply;
        }

        /* ----------------------------------------------------- */
        /* â˜…ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ (1è¡Œ/2è¡Œ) â˜… */
        /* ----------------------------------------------------- */

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚³ãƒ³ãƒ†ãƒŠ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1è¡Œè¡¨ç¤º) */
        .message-content-wrapper {
            display: flex;
            align-items: flex-start; /* ç¸¦æ–¹å‘ã®æƒãˆã‚’ä¸Šç«¯ã« */
            flex-direction: row; 
            min-width: 0;
        }
        
        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒãƒƒã‚¸ã‚’å›²ã‚€ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ1è¡Œè¡¨ç¤ºæ™‚ã¯æ¨ªä¸¦ã³ã®ä¸€éƒ¨ï¼‰ */
        .author-name-container {
            display: flex;
            align-items: center; /* ãƒãƒƒã‚¸ã¨åå‰ã‚’å‚ç›´ã«ä¸­å¤®æƒãˆ */
            flex-shrink: 0; /* ç¸®ã¾ãªã„ */
            margin-right: 0.5rem; /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã®é–“éš” */
            /* ğŸ’¡ å‚ç›´æ–¹å‘ã®èª¿æ•´ã‚’é©ç”¨ */
            transform: translateY(var(--author-vertical-offset-px)); 
        }
        
        /* 2è¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ©ãƒƒãƒ‘ãƒ¼ã‚’ç¸¦ä¸¦ã³ã«ã™ã‚‹ */
        .chat-message.multi-line-mode .message-content-wrapper {
            flex-direction: column; /* ç¸¦ä¸¦ã³ */
            align-items: stretch; /* å†…éƒ¨è¦ç´ ãŒå…¨å¹…ã‚’ä½¿ã†ã‚ˆã†ã« */
        }

        /* 2è¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚³ãƒ³ãƒ†ãƒŠã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .chat-message.multi-line-mode .author-name-container {
            margin-right: 0;
            /* ğŸ’¡ ç¸¦æ–¹å‘ã®ã‚®ãƒ£ãƒƒãƒ—ã‚’é©ç”¨ */
            margin-bottom: var(--author-message-gap-rem); 
            align-self: flex-start; /* å¸¸ã«å·¦å¯„ã› */
            width: 100%; /* å…¨å¹…ã‚’ä½¿ç”¨ */
            /* ğŸ’¡ åå‰ã‚³ãƒ³ãƒ†ãƒŠã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’é©ç”¨ */
            margin-left: var(--author-indent-rem, 0rem); 
        }

        /* ğŸ’¡ ä¿®æ­£ç‚¹: 2è¡Œè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã«ã‚‚ç‹¬ç«‹ã—ãŸã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’é©ç”¨ */
        .chat-message.multi-line-mode .message-text {
            flex-grow: 0; 
            /* ğŸ’¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æœ¬æ–‡ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆå¤‰æ•°ã‚’é©ç”¨ */
            margin-left: var(--message-indent-rem, 0rem); 
        }

        /* ãƒ¦ãƒ¼ã‚¶ãƒ¼å */
        .author-name {
            font-weight: 700;
            white-space: nowrap; 
            /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨ */
            color: var(--normal-author-color-override, var(--author-default-color)); 
            font-size: var(--normal-author-font-size, var(--author-default-size));
            font-family: var(--author-font-family, var(--global-font-family)); 
        }

        /* ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .message-text {
            /* ã‚«ã‚¹ã‚¿ãƒ å¤‰æ•°ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’é©ç”¨ */
            color: var(--normal-message-color-override, var(--message-default-color)); 
            min-width: 0; 
            word-break: break-all; 
            font-size: var(--normal-message-font-size, var(--message-default-size));
            font-family: var(--message-font-family, var(--global-font-family));
            /* ğŸ’¡ æœ€å¤§æ–‡å­—å¹…ã‚’é©ç”¨ (chå˜ä½) */
            max-width: var(--message-max-chars); 
            /* 1è¡Œè¡¨ç¤ºæ™‚ã®èª¿æ•´ */
            flex-grow: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’åŸ‹ã‚ã‚‹ */
        }

        /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢å†…ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã */
        .pinned-message .author-name {
            font-family: var(--pinned-author-font-family, var(--author-font-family, var(--global-font-family)));
            color: var(--pinned-author-color-override, var(--author-color-override, var(--author-default-color)));
            font-size: var(--pinned-author-font-size, var(--author-font-size, var(--author-default-size)));
        }

        .pinned-message .message-text {
            font-family: var(--pinned-message-font-family, var(--message-font-family, var(--global-font-family)));
            color: var(--pinned-message-color-override, var(--message-color-override, var(--message-default-color)));
            font-size: var(--pinned-message-font-size, var(--message-font-size, var(--message-default-size)));
        }


        /* ----------------------------------------------------- */
        /* ç‰¹å®šã®ãƒãƒ£ãƒƒãƒˆã‚¿ã‚¤ãƒ—ã‚„ãƒãƒƒã‚¸ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚¶ã‚¤ãƒ³ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä¸Šæ›¸ã) */
        /* ----------------------------------------------------- */

        /* ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®ãƒãƒƒã‚¸ */
        .is-moderator .author-name {
            /* ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã€Modã‚«ãƒ©ãƒ¼ã‚’å„ªå…ˆ */
            color: #58a6ff !important; 
            text-shadow: 0 0 5px rgba(88, 166, 255, 0.5);
        }
        .is-moderator .chat-message {
            border-left: 4px solid #58a6ff;
        }
        
        /* ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ— */
        .is-member::before {
             background-color: #007799 !important;
        }
        .is-member .author-name {
            color: #00e5ff !important; 
        }

        /* ãƒ¡ãƒ³ãƒãƒ¼ãƒãƒƒã‚¸ï¼ˆã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .membership-badge {
            margin-right: 0.5rem;
            color: #ffd700; 
        }

        /* â˜…ä¿®æ­£: ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆ (ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ã«ã‚‚è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¾©æ´») */
        .is-superchat::before {
            /* æ¿ƒã„èµ¤/ç´«ç³»ã®ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ */
            background: linear-gradient(135deg, #a020f0 0%, #ff4500 100%); 
            opacity: 0.8 !important; /* èƒŒæ™¯ç”»åƒã‚’é©ç”¨ã—ã¦ã„ã‚‹å ´åˆã§ã‚‚ç›®ç«‹ãŸã›ã‚‹ */
            background-color: #ff4500 !important;
            border-left: 6px solid #ffd700; /* é‡‘è‰²ã®ãƒœãƒ¼ãƒ€ãƒ¼ */
        }
        .is-superchat .author-name {
            color: #ffd700 !important; /* ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚‚é‡‘è‰² */
            text-shadow: 0 0 8px rgba(255, 215, 0, 0.6);
        }
        .is-superchat .message-text {
            color: #ffffff !important; 
            font-weight: 600; /* æœ¬æ–‡ã‚’å¼·èª¿ */
        }


        /* ----------------------------------------------------- */
        /* â˜…æ–°è¦: SCã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ«â˜… */
        /* ----------------------------------------------------- */

        /* SCã‚¹ãƒˆãƒƒã‚¯å†…ã®å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .sc-stock-message {
            padding: 0.75rem;
            margin-bottom: 0.75rem; /* é–“éš”ã‚’åºƒã‚ã« */
            border-radius: 8px;
            background-color: #3d1717; /* SCã‚’æ„è­˜ã—ãŸæ¿ƒã„èµ¤èƒŒæ™¯ */
            border: 1px solid #ffaa00;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            animation: fadeIn 0.5s ease-out; 
            overflow: hidden; 
            word-break: break-word; /* é•·ã„ã‚³ãƒ¡ãƒ³ãƒˆã§ã‚‚ç¢ºå®Ÿã«æŠ˜ã‚Šè¿”ã™ */
            flex-shrink: 0; /* â˜…è¿½åŠ : ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ½°ã‚Œãªã„ã‚ˆã†ã«ã™ã‚‹ */
        }

        .sc-stock-message .sc-author {
            font-weight: 700;
            color: #ffffff; /* åå‰ã¯ç™½å›ºå®š */
            font-size: 0.9rem;
            margin-right: 0.5rem;
        }

        .sc-stock-message .sc-amount {
            font-weight: 800;
            color: #ffcc00; /* é‡‘é¡ã¯é»„è‰² */
            font-size: 1.1rem;
            display: block;
            /* å‚ç›´æ–¹å‘ã®èª¿æ•´ */
            transform: translateY(1px);
        }
        
        .sc-stock-message .sc-comment {
            font-size: 0.85rem;
            color: #e0e0e0;
            margin-top: 0.5rem;
        }

        /* ----------------------------------------------------- */
        /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ«â˜… */
        /* ----------------------------------------------------- */
        #pinned-chat-container {
            /* â˜…ä¿®æ­£: position:fixed ã‚’ã‚„ã‚ã¦é€šå¸¸ã®Flexã‚¢ã‚¤ãƒ†ãƒ ã«ã™ã‚‹ */
            flex-shrink: 0; /* é«˜ã•ãŒç¸®ã¾ãªã„ã‚ˆã†ã«ã™ã‚‹ */
            height: var(--pinned-chat-height);
            background-color: rgba(10, 10, 10, 0.85); /* å°‘ã—é€æ˜ãªé»’ */
            backdrop-filter: blur(8px); /* èƒŒæ™¯ã‚’ã¼ã‹ã™ */
            border-top: 2px solid #4a5568;
            padding: 0.75rem;
            display: flex; 
            flex-direction: column-reverse; /* æ–°ã—ã„ãƒ”ãƒ³ãŒä¸‹ã‹ã‚‰ä¸Šã«ç©ã¾ã‚Œã‚‹ */
            gap: 0.5rem;
            overflow-y: hidden; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã•ã›ãªã„ */
            width: 100%;
        }

        /* ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
        .pinned-message {
            cursor: pointer; /* ãƒ”ãƒ³ç•™ã‚è§£é™¤ãŒã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */
            border-left: 4px solid #f59e0b; /* ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®ãƒœãƒ¼ãƒ€ãƒ¼ã§å¼·èª¿ */
            /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢å†…ã§é«˜ã•ãŒæ½°ã‚Œãªã„ã‚ˆã†ã« */
            flex-shrink: 0;
            width: 100%; /* â˜…è¿½åŠ : å†…å®¹ã«é–¢ã‚ã‚‰ãšå¹…ã‚’100%ã«ã™ã‚‹ */
        }

        /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒãƒ£ãƒƒãƒˆã®æœ¬æ–‡ã¯æ–‡å­—æ•°åˆ¶é™ã‚’è§£é™¤ */
        .pinned-message .message-text {
            max-width: none;
        }

        /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚è§£é™¤ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pinned-message.hiding {
            animation: fadeOutDown 0.4s ease-in forwards;
        }

        /* â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¢ã‚¤ã‚³ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .pin-icon {
            margin-right: 0.4rem;
            color: #f59e0b; /* ãƒ”ãƒ³ã®ãƒœãƒ¼ãƒ€ãƒ¼è‰²ã¨åˆã‚ã›ã‚‹ */
            cursor: pointer; /* â˜…è¿½åŠ : ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹ã“ã¨ã‚’ç¤ºã™ */
        }

        /* ----------------------------------------------------- */
        /* â˜…æ–°è¦: ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã®ã‚¹ã‚¿ã‚¤ãƒ«â˜… */
        /* ----------------------------------------------------- */
        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .toast-message {
            background-color: rgba(30, 41, 59, 0.9); /* bg-slate-800/90 */
            backdrop-filter: blur(4px);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem; /* rounded-lg */
            border-left: 4px solid #38bdf8; /* border-sky-400 */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: toast-in 0.4s ease-out forwards;
            min-width: 250px;
            max-width: 400px;
        }
        .toast-message.hiding {
            animation: toast-out 0.4s ease-in forwards;
        }

        /* â˜…æ–°è¦: ãƒˆãƒ¼ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes toast-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        @keyframes toast-out {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }

        /* ----------------------------------------------------- */
        /* â˜…æ–°è¦: ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³UIã®ã‚¹ã‚¿ã‚¤ãƒ«â˜… */
        /* ----------------------------------------------------- */
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 0.75rem;
            font-weight: 600;
            text-align: left;
            background-color: #374151; /* bg-gray-700 */
            color: #d1d5db; /* text-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.2s ease-in-out;
        }
        .accordion-header:hover {
            background-color: #4b5563; /* bg-gray-600 */
        }
        .accordion-header.active {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        .accordion-header .icon::before {
            content: 'â–¼';
            display: inline-block;
            transition: transform 0.3s ease;
            font-size: 0.8em;
        }
        .accordion-header.active .icon::before {
            transform: rotate(180deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            background-color: #1f2937; /* bg-gray-800 */
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            padding: 0 1rem;
        }

        /* â˜…æ–°è¦: ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ãŒå®Œå…¨ã«é–‹ã„ãŸå¾Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .accordion-content.open {
            max-height: none;
        }

    </style>
</head>
<body class="bg-gray-800 text-white">

    <!-- åˆ¶å¾¡ãƒ‘ãƒãƒ«ã‚³ãƒ³ãƒ†ãƒŠ (å·¦å´/ä¸Šéƒ¨) -->
    <div id="control-panel-container" class="bg-gray-900 md:h-screen md:sticky md:top-0 p-4">
        <!-- â˜…ä¿®æ­£: å…¨ä½“ã‚’å›²ã‚€flexã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ  -->
        <div class="flex flex-col h-full gap-4">
            <div>
                <!-- 1. API/å‹•ç”»è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="w-full p-4 bg-gray-800 rounded-lg shadow-xl">
                    <h1 class="text-2xl font-extrabold mb-1 text-blue-400 border-b border-blue-400/50 pb-2">ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆè¨­å®š</h1>
                    <p class="text-sm text-gray-400 mb-4">APIã‚­ãƒ¼ã¨å‹•ç”»IDã‚’å…¥åŠ›</p>
                    
                    <div class="flex flex-col gap-3 w-full"> 
                        <!-- å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’æ”¹å–„ (p-3, rounded-lg, bg-gray-700, focus:ring-2) -->
                        <input type="text" id="api-key" placeholder="YouTube API Key" class="p-3 border border-gray-600 rounded-lg bg-gray-700 text-white w-full focus:ring-2 focus:ring-blue-500" value="">
                        <input type="text" id="video-id" placeholder="YouTube Video ID or URL" class="p-3 border border-gray-600 rounded-lg bg-gray-700 text-white w-full focus:ring-2 focus:ring-blue-500" value="">
                    </div>
                </div>
            </div>

            <!-- 2. ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ (flex-growã§é«˜ã•ã‚’ç¢ºä¿) -->
            <div class="w-full flex-grow p-4 bg-gray-800 rounded-lg shadow-xl overflow-y-auto min-h-0">
                <div>
                    <h2 class="text-xl font-bold mb-4 text-blue-300 border-b border-gray-600 pb-2">ãƒ‡ã‚¶ã‚¤ãƒ³ã‚«ã‚¹ã‚¿ãƒ </h2>
                    
                    <!-- â˜…ä¿®æ­£: ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³UIã®ã‚³ãƒ³ãƒ†ãƒŠã«å¤‰æ›´ -->
                    <div id="accordion-container" class="flex flex-col gap-3">
                        
                        <!-- ã‚°ãƒ«ãƒ¼ãƒ—: èƒŒæ™¯ç”»åƒè¨­å®š (æ–°ã—ã„ã‚°ãƒ«ãƒ¼ãƒ—) -->
                        <div class="accordion-item">
                            <button class="accordion-header"><h3>èƒŒæ™¯ç”»åƒ</h3><span class="icon"></span></button>
                            <div class="accordion-content">
                                <div class="py-4">
                                    <input type="text" id="background-image-url" placeholder="èƒŒæ™¯ç”»åƒURL (GIF/PNG/JPG) (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)" class="p-3 border border-gray-600 rounded-lg bg-gray-700 text-white w-full focus:ring-2 focus:ring-blue-500" value="">
                                </div>
                            </div>
                        </div>

                        <!-- ã‚°ãƒ«ãƒ¼ãƒ—: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š -->
                        <div class="accordion-item">
                            <button class="accordion-header"><h3>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</h3><span class="icon"></span></button>
                            <div class="accordion-content">
                                <div class="py-4 flex flex-col gap-4">
                        <!-- 1è¡Œã‚ãŸã‚Šã®æ–‡å­—æ•°è¨­å®š -->
                        <div class="flex flex-col gap-2 mb-3">
                            <label class="w-full text-sm font-medium text-gray-300 mb-1">
                                ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ã®æœ€å¤§æ–‡å­—æ•° (1è¡Œ): <span id="char-limit-display" class="font-mono text-blue-300">80æ–‡å­—</span>
                            </label>
                            <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼: min=20æ–‡å­—, max=120æ–‡å­—, step=1æ–‡å­— -->
                            <input type="range" id="char-limit-range" min="20" max="120" step="1" value="80" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- è¡¨ç¤ºè¡Œæ•°è¨­å®š (å¸¸ã«ç¸¦ä¸¦ã³) -->
                        <div class="flex flex-col gap-2 mb-3">
                            <label class="w-full text-sm font-medium text-gray-300 mb-1">è¡¨ç¤ºè¡Œæ•°:</label>
                            <select id="chat-display-mode" class="p-2 border border-gray-500 rounded-md bg-gray-600 text-white w-full cursor-pointer focus:ring-1 focus:ring-blue-500">
                                <option value="single">1è¡Œè¡¨ç¤º (åå‰ã¨æœ¬æ–‡ãŒæ¨ªä¸¦ã³)</option>
                                <option value="multi" selected>2è¡Œè¡¨ç¤º (åå‰ã¨æœ¬æ–‡ãŒç¸¦ä¸¦ã³)</option>
                            </select>
                        </div>
                        
                        <!-- ğŸ’¡ åå‰ã¨æœ¬æ–‡ã®ä¸Šä¸‹ã®é–“éš”è¨­å®š -->
                        <div class="flex flex-col gap-2 mb-3">
                            <label class="w-full text-sm font-medium text-gray-300 mb-1">
                                åå‰ã¨æœ¬æ–‡ã®ä¸Šä¸‹ã®é–“éš”: <span id="gap-display" class="font-mono text-blue-300">0.2rem</span>
                            </label>
                            <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼: min=0rem, max=2.0rem, step=0.1rem -->
                            <input type="range" id="author-message-gap-range" min="0" max="2.0" step="0.1" value="0.2" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>

                        <!-- ğŸ’¡ åå‰ å‚ç›´ä½ç½®èª¿æ•´è¨­å®š (2è¡Œè¡¨ç¤ºæ™‚ã®ã¿æœ‰åŠ¹) -->
                        <div class="flex flex-col gap-2 mb-3 border-t border-gray-600 pt-3 mt-3">
                            <label class="w-full text-sm font-medium text-gray-300 mb-1">
                                åå‰ å‚ç›´ä½ç½®èª¿æ•´ (2è¡Œæ™‚): <span id="author-v-offset-display" class="font-mono text-blue-300">0px</span>
                            </label>
                            <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼: min=-10px, max=10px, step=1px -->
                            <input type="range" id="author-v-offset-range" min="-10" max="10" step="1" value="0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>


                        <!-- ğŸ’¡ ç‹¬ç«‹ã—ãŸã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆèª¿æ•´è¨­å®šã‚°ãƒ«ãƒ¼ãƒ— -->
                        <div id="indent-settings-group" class="border-t border-gray-600 pt-3">
                             <!-- åå‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼‰ã®å·¦ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆèª¿æ•´è¨­å®š -->
                            <div class="flex flex-col gap-2 mb-3" id="author-indent-setting">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">åå‰ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ (2è¡Œæ™‚) <span id="author-indent-display" class="font-mono text-blue-300">0.0rem</span></label>
                                <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼: min=0rem, max=20rem, step=0.1rem -->
                                <input type="range" id="author-indent-range" min="0" max="20.0" step="0.1" value="0.0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>

                            <!-- æœ¬æ–‡ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã®å·¦ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆèª¿æ•´è¨­å®š -->
                            <div class="flex flex-col gap-2" id="message-indent-setting">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">æœ¬æ–‡ã®ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ (2è¡Œæ™‚) <span id="message-indent-display" class="font-mono text-blue-300">0.0rem</span></label>
                                <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼: min=0rem, max=20rem, step=0.1rem -->
                                <input type="range" id="message-indent-range" min="0" max="20.0" step="0.1" value="0.0" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                                </div>
                            </div>
                        </div>


                        <!-- ã‚°ãƒ«ãƒ¼ãƒ—: ãƒ•ã‚©ãƒ³ãƒˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ -->
                        <div class="accordion-item">
                            <button class="accordion-header"><h3>ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š</h3><span class="icon"></span></button>
                            <div class="accordion-content">
                                <div class="py-4 flex flex-col gap-4">
                        <div class="flex flex-col gap-3">
                            <!-- ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ•ã‚©ãƒ³ãƒˆ (å¸¸ã«ç¸¦ä¸¦ã³) -->
                            <div class="flex flex-col gap-2">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">å…¨ä½“ãƒ•ã‚©ãƒ³ãƒˆ:</label>
                                <select id="global-font-family" class="p-2 border border-gray-500 rounded-md bg-gray-600 text-white w-full cursor-pointer focus:ring-1 focus:ring-blue-500">
                                    <option value="'Noto Sans JP', 'Inter', sans-serif">Noto Sans JP (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                                    <option value="'Meiryo', sans-serif">ãƒ¡ã‚¤ãƒªã‚ª</option>
                                    <option value="'Yu Gothic', sans-serif">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                                    <option value="'Inter', sans-serif">Inter (æ¬§æ–‡)</option>
                                    <option value="'Arial', sans-serif">Arial (æ±ç”¨)</option>
                                    <option value="'Courier New', monospace">Courier New (ç­‰å¹…)</option>
                                </select>
                            </div>
                            
                            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ•ã‚©ãƒ³ãƒˆ (å¸¸ã«ç¸¦ä¸¦ã³) -->
                            <div class="flex flex-col gap-2">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ•ã‚©ãƒ³ãƒˆ:</label>
                                <select id="author-font-family" class="p-2 border border-gray-500 rounded-md bg-gray-600 text-white w-full cursor-pointer focus:ring-1 focus:ring-blue-500">
                                    <option value="">ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å¾“ã† (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                                    <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
                                    <option value="'Meiryo', sans-serif">ãƒ¡ã‚¤ãƒªã‚ª</option>
                                    <option value="'Yu Gothic', sans-serif">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                                    <option value="'Inter', sans-serif">Inter (æ¬§æ–‡)</option>
                                    <option value="'Courier New', monospace">Courier New (ç­‰å¹…)</option>
                                </select>
                            </div>
                            
                            <!-- ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ãƒ•ã‚©ãƒ³ãƒˆ (å¸¸ã«ç¸¦ä¸¦ã³) -->
                            <div class="flex flex-col gap-2">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ãƒ•ã‚©ãƒ³ãƒˆ:</label>
                                <select id="message-font-family" class="p-2 border border-gray-500 rounded-md bg-gray-600 text-white w-full cursor-pointer focus:ring-1 focus:ring-blue-500">
                                    <option value="">ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å¾“ã† (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)</option>
                                    <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
                                    <option value="'Meiryo', sans-serif">ãƒ¡ã‚¤ãƒªã‚ª</option>
                                    <option value="'Yu Gothic', sans-serif">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
                                    <option value="'Inter', sans-serif">Inter (æ¬§æ–‡)</option>
                                    <option value="'Arial', sans-serif">Arial (æ±ç”¨)</option>
                                    <option value="'Courier New', monospace">Courier New (ç­‰å¹…)</option>
                                </select>
                            </div>

                            <!-- â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ•ã‚©ãƒ³ãƒˆ -->
                            <div class="flex flex-col gap-2 border-t border-gray-600 pt-3 mt-3">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒ”ãƒ³ç•™ã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ•ã‚©ãƒ³ãƒˆ:</label>
                                <select id="pinned-author-font-family" class="p-2 border border-gray-500 rounded-md bg-gray-600 text-white w-full cursor-pointer focus:ring-1 focus:ring-blue-500">
                                    <option value="">é€šå¸¸ã‚¨ãƒªã‚¢ã«å¾“ã†</option>
                                    <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
                                    <option value="'Meiryo', sans-serif">ãƒ¡ã‚¤ãƒªã‚ª</option>
                                    <option value="'Inter', sans-serif">Inter (æ¬§æ–‡)</option>
                                </select>
                            </div>

                            <!-- â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ãƒ•ã‚©ãƒ³ãƒˆ -->
                            <div class="flex flex-col gap-2">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ãƒ•ã‚©ãƒ³ãƒˆ:</label>
                                <select id="pinned-message-font-family" class="p-2 border border-gray-500 rounded-md bg-gray-600 text-white w-full cursor-pointer focus:ring-1 focus:ring-blue-500">
                                    <option value="">é€šå¸¸ã‚¨ãƒªã‚¢ã«å¾“ã†</option>
                                    <option value="'Noto Sans JP', sans-serif">Noto Sans JP</option>
                                    <option value="'Meiryo', sans-serif">ãƒ¡ã‚¤ãƒªã‚ª</option>
                                    <option value="'Inter', sans-serif">Inter (æ¬§æ–‡)</option>
                                </select>
                            </div>
                        </div>
                                </div>
                            </div>
                        </div>

                        <!-- ã‚°ãƒ«ãƒ¼ãƒ—: ã‚µã‚¤ã‚ºã¨è‰² -->
                        <div class="accordion-item">
                            <button class="accordion-header active"><h3>ã‚µã‚¤ã‚ºã¨è‰²</h3><span class="icon"></span></button>
                            <div class="accordion-content">
                                <div class="py-4 flex flex-col gap-4">
                        <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã‚µã‚¤ã‚º/è‰²è¨­å®š (å¸¸ã«ç¸¦ä¸¦ã³) -->
                        <div class="flex flex-col gap-2 mb-3">
                            <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                            <!-- ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³ã¨ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ (æ¨ªä¸¦ã³ç¶­æŒ) -->
                            <div class="flex items-center gap-3 w-full"> 
                                <!-- ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³ã¨è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                                <div class="flex items-stretch flex-grow">
                                    <button id="author-size-down" class="bg-red-600 hover:bg-red-700 text-white font-bold text-lg py-1 px-3 rounded-l-lg transition duration-150 shadow-md" aria-label="ã‚µã‚¤ã‚ºã‚’å°ã•ã">-</button>
                                    <input type="text" id="author-font-size" class="p-2 border-y border-gray-600 bg-gray-800 text-white text-center w-full focus:ring-1 focus:ring-blue-500" value="1.0rem" readonly>
                                    <button id="author-size-up" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg py-1 px-3 rounded-r-lg transition duration-150 shadow-md" aria-label="ã‚µã‚¤ã‚ºã‚’å¤§ãã">+</button>
                                </div>
                                <!-- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ (å¹…ã‚’å›ºå®š) -->
                                <input type="color" id="author-color" class="h-10 w-12 cursor-pointer bg-gray-800 rounded-lg border border-gray-600 shadow-md flex-shrink-0" value="#fec834">
                            </div>
                        </div>

                        <!-- ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ ã‚µã‚¤ã‚º/è‰²è¨­å®š (å¸¸ã«ç¸¦ä¸¦ã³) -->
                        <div class="flex flex-col gap-2">
                            <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡:</label>
                            <!-- ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³ã¨ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®ã‚³ãƒ³ãƒ†ãƒŠ (æ¨ªä¸¦ã³ç¶­æŒ) -->
                            <div class="flex items-center gap-3 w-full"> 
                                <!-- ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³ã¨è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                                <div class="flex items-stretch flex-grow">
                                    <button id="message-size-down" class="bg-red-600 hover:bg-red-700 text-white font-bold text-lg py-1 px-3 rounded-l-lg transition duration-150 shadow-md" aria-label="ã‚µã‚¤ã‚ºã‚’å°ã•ã">-</button>
                                    <input type="text" id="message-font-size" class="p-2 border-y border-gray-600 bg-gray-800 text-white text-center w-full focus:ring-1 focus:ring-blue-500" value="1.0rem" readonly>
                                    <button id="message-size-up" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg py-1 px-3 rounded-r-lg transition duration-150 shadow-md" aria-label="ã‚µã‚¤ã‚ºã‚’å¤§ãã">+</button>
                                </div>
                                <!-- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ (å¹…ã‚’å›ºå®š) -->
                                <input type="color" id="message-color" class="h-10 w-12 cursor-pointer bg-gray-800 rounded-lg border border-gray-600 shadow-md flex-shrink-0" value="#e2e8f0">
                            </div>
                        </div>

                        <!-- â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢å°‚ç”¨ã®ã‚µã‚¤ã‚ºã¨è‰² -->
                        <div class="border-t border-gray-600 pt-3 mt-3">
                            <h4 class="text-sm font-semibold mb-2 text-yellow-300">ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢å°‚ç”¨</h4>
                            <!-- ãƒ”ãƒ³ç•™ã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã‚µã‚¤ã‚º/è‰²è¨­å®š -->
                            <div class="flex flex-col gap-2 mb-3">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒ”ãƒ³ç•™ã‚ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
                                <div class="flex items-center gap-3 w-full">
                                    <div class="flex items-stretch flex-grow">
                                        <button id="pinned-author-size-down" class="bg-red-600 hover:bg-red-700 text-white font-bold text-lg py-1 px-3 rounded-l-lg transition duration-150 shadow-md">-</button>
                                        <input type="text" id="pinned-author-font-size" class="p-2 border-y border-gray-600 bg-gray-800 text-white text-center w-full" value="1.0rem" readonly>
                                        <button id="pinned-author-size-up" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg py-1 px-3 rounded-r-lg transition duration-150 shadow-md">+</button>
                                    </div>
                                </div>
                            </div>
                            <!-- ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ ã‚µã‚¤ã‚º/è‰²è¨­å®š -->
                            <div class="flex flex-col gap-2">
                                <label class="w-full text-sm font-medium text-gray-300 mb-1">ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡:</label>
                                <div class="flex items-center gap-3 w-full">
                                    <div class="flex items-stretch flex-grow">
                                        <button id="pinned-message-size-down" class="bg-red-600 hover:bg-red-700 text-white font-bold text-lg py-1 px-3 rounded-l-lg transition duration-150 shadow-md">-</button>
                                        <input type="text" id="pinned-message-font-size" class="p-2 border-y border-gray-600 bg-gray-800 text-white text-center w-full" value="1.0rem" readonly>
                                        <button id="pinned-message-size-up" class="bg-green-600 hover:bg-green-700 text-white font-bold text-lg py-1 px-3 rounded-r-lg transition duration-150 shadow-md">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <!-- 3. åˆ¶å¾¡ãƒœã‚¿ãƒ³ç¾¤ -->
                <div class="flex flex-col gap-3 w-full">
                    <!-- â˜…ä¿®æ­£: ãƒœã‚¿ãƒ³ã®é«˜ã•ã‚’ä½ãã—ã¦æ“ä½œã‚¨ãƒªã‚¢ã‚’åºƒã’ã‚‹ -->
                    <button id="save-button" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full text-base shadow-xl">è¨­å®šã‚’ä¿å­˜</button>
                    
                    <!-- ãƒœã‚¿ãƒ³ã‚’å¤§ããã—ã€ã‚·ãƒ£ãƒ‰ã‚¦ã‚’è¿½åŠ  -->
                    <button id="start-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full text-base shadow-xl">ãƒãƒ£ãƒƒãƒˆå–å¾—é–‹å§‹</button>
                    <button id="dummy-button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-full text-base shadow-xl">ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆ</button>
                    <!-- â˜…ä¿®æ­£: ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚’2ã¤ã«åˆ†å‰²ã—ã¦æ¨ªä¸¦ã³ã«ã™ã‚‹ -->
                    <div class="flex gap-2 w-full">
                        <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-1/2 text-base shadow-xl">å…¨ã‚¯ãƒªã‚¢</button>
                        <button id="clear-pinned-button" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 w-1/2 text-base shadow-xl">ãƒ”ãƒ³ã®ã¿<br>ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- â˜…ä¿®æ­£: ãƒ¡ã‚¤ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ã®ãƒ©ãƒƒãƒ‘ãƒ¼æ§‹é€ ã‚’å¤‰æ›´ -->
    <div id="main-display-wrapper"> 
        <!-- ãƒãƒ£ãƒƒãƒˆã¨SCã‚’å›²ã‚€ãƒ©ãƒƒãƒ‘ãƒ¼ -->
        <div id="chat-and-sc-wrapper">
            <!-- ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ (å·¦å´) -->
            <div id="chat-container">
                <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ (æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸‹) -->
            </div>
            
            <!-- ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ (å³å´) -->
            <div id="superchat-stock-container">
                <div class="p-4 border-b border-yellow-500/50">
                    <h2 class="text-xl font-bold text-yellow-400">ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆã‚¹ãƒˆãƒƒã‚¯</h2>
                </div>
                <!-- SCãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ (æœ€æ–°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒä¸Š) -->
            </div>
        </div>

        <!-- ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ (ä¸‹éƒ¨) -->
    <div id="pinned-chat-container">
        <!-- ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸãƒãƒ£ãƒƒãƒˆãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </div>

    <!-- â˜…ä¿®æ­£: å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã®ã‚³ãƒ¼ãƒ‰ã‚’å®Œå…¨ã«å‰Šé™¤ -->

    <!-- â˜…ä¿®æ­£: ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="toast-container">
        <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
    </div>
</div>


<script type="text/javascript">
    // --------------------------------------------------------------------------------
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // --------------------------------------------------------------------------------
    
    // localStorageä¿å­˜ç”¨ã®ã‚­ãƒ¼
    const STORAGE_KEY = 'chatViewerCustomDesignSettings';

    const API_BASE_URL = 'https://www.googleapis.com/youtube/v3/liveChat/messages';
    let apiKey = '';
    let liveChatId = '';
    let nextPageToken = '';
    let pollingInterval = 5000; 
    let isPolling = false;

    const chatContainer = document.getElementById('chat-container');
    // â˜…æ–°è¦: SCã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ã®å–å¾—
    const superchatStockContainer = document.getElementById('superchat-stock-container');
    // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ã®å–å¾—
    const pinnedChatContainer = document.getElementById('pinned-chat-container');
    
    const startButton = document.getElementById('start-button');
    const dummyButton = document.getElementById('dummy-button');
    const resetButton = document.getElementById('reset-button');
    // â˜…æ–°è¦: ãƒ”ãƒ³ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã®å–å¾—
    const clearPinnedButton = document.getElementById('clear-pinned-button');
    
    const saveButton = document.getElementById('save-button'); 

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    const apiKeyInput = document.getElementById('api-key');
    const videoIdInput = document.getElementById('video-id');
    const backgroundImageInput = document.getElementById('background-image-url');
    
    // ã‚«ã‚¹ã‚¿ãƒ è¨­å®šå…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    const globalFontInput = document.getElementById('global-font-family'); 
    const authorFontInput = document.getElementById('author-font-family'); 
    const messageFontInput = document.getElementById('message-font-family'); 

    // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢å°‚ç”¨ã®ãƒ•ã‚©ãƒ³ãƒˆ/ã‚µã‚¤ã‚º/ã‚«ãƒ©ãƒ¼åˆ¶å¾¡è¦ç´ 
    const pinnedAuthorFontInput = document.getElementById('pinned-author-font-family');
    const pinnedMessageFontInput = document.getElementById('pinned-message-font-family');
    const pinnedAuthorSizeInput = document.getElementById('pinned-author-font-size');
    const pinnedAuthorSizeUpButton = document.getElementById('pinned-author-size-up');
    const pinnedAuthorSizeDownButton = document.getElementById('pinned-author-size-down');
    const pinnedMessageSizeInput = document.getElementById('pinned-message-font-size');
    const pinnedMessageSizeUpButton = document.getElementById('pinned-message-size-up');
    const pinnedMessageSizeDownButton = document.getElementById('pinned-message-size-down');
    
    // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º/ã‚«ãƒ©ãƒ¼åˆ¶å¾¡è¦ç´ 
    const authorSizeInput = document.getElementById('author-font-size');
    const authorSizeUpButton = document.getElementById('author-size-up'); 
    const authorSizeDownButton = document.getElementById('author-size-down'); 

    const messageSizeInput = document.getElementById('message-font-size');
    const messageSizeUpButton = document.getElementById('message-size-up');
    const messageSizeDownButton = document.getElementById('message-size-down');

    const authorColorInput = document.getElementById('author-color');
    const messageColorInput = document.getElementById('message-color');
    
    // è¡Œæ•°ãƒ»é…ç½®åˆ¶å¾¡è¦ç´ 
    const chatDisplayModeInput = document.getElementById('chat-display-mode');
    
    // æ–‡å­—æ•°ãƒ»é–“éš”åˆ¶å¾¡è¦ç´ 
    const charLimitRange = document.getElementById('char-limit-range');
    const charLimitDisplay = document.getElementById('char-limit-display');
    const authorMessageGapRange = document.getElementById('author-message-gap-range');
    const gapDisplay = document.getElementById('gap-display');
    
    // ğŸ’¡ å‚ç›´ä½ç½®èª¿æ•´åˆ¶å¾¡è¦ç´ 
    const authorVOffsetRange = document.getElementById('author-v-offset-range');
    const authorVOffsetDisplay = document.getElementById('author-v-offset-display');
    
    // ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆåˆ¶å¾¡è¦ç´ 
    const indentSettingsGroupDiv = document.getElementById('indent-settings-group');
    const authorIndentRange = document.getElementById('author-indent-range');
    const authorIndentDisplay = document.getElementById('author-indent-display');
    const messageIndentRange = document.getElementById('message-indent-range');
    const messageIndentDisplay = document.getElementById('message-indent-display');
    
    // ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã®çŠ¶æ…‹ç®¡ç†ï¼ˆremå˜ä½ã€å°æ•°ç‚¹ä»¥ä¸‹1æ¡ï¼‰
    let authorFontSizeRem = 1.0;
    let messageFontSizeRem = 1.0;
    const FONT_STEP = 0.1;
    const MIN_FONT_SIZE = 0.5;
    const MAX_FONT_SIZE = 3.0;
    // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºç®¡ç†
    let pinnedAuthorFontSizeRem = 1.0;
    let pinnedMessageFontSizeRem = 1.0;

    // â˜…ä¿®æ­£: DOMã«ä¿æŒã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æœ€å¤§æ•° (ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãŸã‚)
    const MAX_DOM_MESSAGES = 100;
    
    // --------------------------------------------------------------------------------
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£: ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹
    // --------------------------------------------------------------------------------
    // â˜…ä¿®æ­£: ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã«å¤‰æ›´
    function showMessageBox(title, content) {
        const toastContainer = document.getElementById('toast-container');
        
        const toast = document.createElement('div');
        toast.className = 'toast-message';
        
        const toastTitle = document.createElement('h3');
        toastTitle.className = 'font-bold text-sky-300 mb-1';
        toastTitle.textContent = title;

        const toastContent = document.createElement('p');
        toastContent.className = 'text-sm text-gray-200';
        toastContent.textContent = content;

        toast.appendChild(toastTitle);
        toast.appendChild(toastContent);
        toastContainer.appendChild(toast);

        // 5ç§’å¾Œã«ãƒˆãƒ¼ã‚¹ãƒˆã‚’å‰Šé™¤
        setTimeout(() => {
            toast.classList.add('hiding');
            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«DOMã‹ã‚‰å‰Šé™¤
            toast.addEventListener('animationend', () => toast.remove());
        }, 5000);
    }

    // --------------------------------------------------------------------------------
    // ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã®ä¿å­˜/ãƒ­ãƒ¼ãƒ‰ (localStorage)
    // --------------------------------------------------------------------------------
    
    // ã™ã¹ã¦ã®ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã‚’UIã‹ã‚‰å–å¾—ã™ã‚‹é–¢æ•°
    function getCurrentDesignSettings() {
        return {
            // APIè¨­å®šã‚‚ä¿å­˜å¯¾è±¡ã«å«ã‚ã‚‹
            apiKey: apiKeyInput.value.trim(),
            videoId: videoIdInput.value.trim(),

            // ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š
            globalFont: globalFontInput.value,
            authorFont: authorFontInput.value,
            messageFont: messageFontInput.value,
            authorSize: authorSizeInput.value,
            authorColor: authorColorInput.value,
            messageSize: messageSizeInput.value,
            messageColor: messageColorInput.value,
            backgroundImageUrl: backgroundImageInput.value,
            charLimit: parseInt(charLimitRange.value, 10),
            displayMode: chatDisplayModeInput.value,
            authorMessageGap: parseFloat(authorMessageGapRange.value),
            authorVOffset: parseInt(authorVOffsetRange.value, 10), // ğŸ’¡ å‚ç›´ä½ç½®
            authorIndent: parseFloat(authorIndentRange.value),
            messageIndent: parseFloat(messageIndentRange.value),
            // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚è¨­å®š
            pinnedAuthorFont: pinnedAuthorFontInput.value,
            pinnedMessageFont: pinnedMessageFontInput.value,
            pinnedAuthorSize: pinnedAuthorSizeInput.value,
            pinnedMessageSize: pinnedMessageSizeInput.value,
        };
    }

    // ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã‚’localStorageã«ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveDesignSettings() {
        const settingsData = getCurrentDesignSettings();
        
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settingsData));
            showMessageBox('ä¿å­˜å®Œäº†', 'ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šï¼ˆAPIè¨­å®šã‚’å«ã‚€ï¼‰ãŒãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
        } catch (e) {
            console.error('Error saving to localStorage: ', e);
            showMessageBox('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'è¨­å®šã®ä¿å­˜ä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šï¼ˆãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ–ãƒ©ã‚¦ã‚¸ãƒ³ã‚°ãªã©ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }
    }

    // JSONãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦UIè¦ç´ ã«å€¤ã‚’é©ç”¨ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function applySettingsToUI(data) {
        // APIè¨­å®šã®å¾©å…ƒ
        apiKeyInput.value = data.apiKey || '';
        videoIdInput.value = data.videoId || '';

        // ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã®å¾©å…ƒ
        globalFontInput.value = data.globalFont || globalFontInput.value;
        authorFontInput.value = data.authorFont || authorFontInput.value;
        messageFontInput.value = data.messageFont || messageFontInput.value;
        
        // ã‚µã‚¤ã‚ºã¯å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã«ä¸¸ã‚ã¦ä»£å…¥
        const savedAuthorSizeRem = parseFloat(data.authorSize);
        authorSizeInput.value = (savedAuthorSizeRem || 1.0).toFixed(1) + 'rem';
        authorFontSizeRem = savedAuthorSizeRem || 1.0;
        
        const savedMessageSizeRem = parseFloat(data.messageSize);
        messageSizeInput.value = (savedMessageSizeRem || 1.0).toFixed(1) + 'rem';
        messageFontSizeRem = savedMessageSizeRem || 1.0;
        
        authorColorInput.value = data.authorColor || authorColorInput.value;
        messageColorInput.value = data.messageColor || messageColorInput.value;
        
        backgroundImageInput.value = data.backgroundImageUrl || backgroundImageInput.value;

        charLimitRange.value = data.charLimit || 80;
        
        chatDisplayModeInput.value = data.displayMode || 'multi';

        authorMessageGapRange.value = (parseFloat(data.authorMessageGap) || 0.2).toFixed(1);
        
        // ğŸ’¡ å‚ç›´ä½ç½®ã®å¾©å…ƒ
        authorVOffsetRange.value = data.authorVOffset || 0;
        
        authorIndentRange.value = (parseFloat(data.authorIndent) || 0.0).toFixed(1);
        messageIndentRange.value = (parseFloat(data.messageIndent) || 0.0).toFixed(1);

        // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚è¨­å®šã®å¾©å…ƒ
        pinnedAuthorFontInput.value = data.pinnedAuthorFont || '';
        pinnedMessageFontInput.value = data.pinnedMessageFont || '';

        const savedPinnedAuthorSizeRem = parseFloat(data.pinnedAuthorSize);
        pinnedAuthorSizeInput.value = (savedPinnedAuthorSizeRem || 1.0).toFixed(1) + 'rem';
        pinnedAuthorFontSizeRem = savedPinnedAuthorSizeRem || 1.0;

        const savedPinnedMessageSizeRem = parseFloat(data.pinnedMessageSize);
        pinnedMessageSizeInput.value = (savedPinnedMessageSizeRem || 1.0).toFixed(1) + 'rem';
        pinnedMessageFontSizeRem = savedPinnedMessageSizeRem || 1.0;
    }

    // ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿ã€UIã«é©ç”¨ã™ã‚‹é–¢æ•°
    function loadDesignSettings() {
        try {
            const storedSettings = localStorage.getItem(STORAGE_KEY);
            if (storedSettings) {
                const data = JSON.parse(storedSettings);
                applySettingsToUI(data);
                console.log("Design settings loaded from localStorage.");
            } else {
                console.log("No design settings found in localStorage. Using default.");
            }
        } catch (e) {
            console.error('Error loading from localStorage: ', e);
        }
        
        // èª­ã¿è¾¼ã¿çµæœã«é–¢ã‚ã‚‰ãšã€UIã®åˆæœŸåŒ–ã¨CSSå¤‰æ•°ã®é©ç”¨ã¯è¡Œã†
        initializeLayoutSettings();
    }


    // --------------------------------------------------------------------------------
    // YouTube API Core Functions (No Change)
    // --------------------------------------------------------------------------------
    
    function extractVideoId(input) {
        const urlPattern = /(?:youtu\.be\/|youtube\.com\/(?:watch\?.*v=|embed\/|v\/|shorts\/))([\w-]{11})/;
        const match = input.match(urlPattern);

        if (match) {
            return match[1];
        }

        if (/^[\w-]{11}$/.test(input)) {
            return input;
        }

        return null;
    }


    async function fetchLiveChatId(videoId) {
        // APIã‚­ãƒ¼ã¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å†å–å¾—ã™ã‚‹
        apiKey = apiKeyInput.value.trim(); 
        const url = `https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoId}&key=${apiKey}`;

        try {
            const response = await fetch(url);
            const data = await response.json();

            if (data.items && data.items.length > 0) {
                const details = data.items[0].liveStreamingDetails;
                if (details && details.activeLiveChatId) {
                    return details.activeLiveChatId;
                }
            }
            showMessageBox('ã‚¨ãƒ©ãƒ¼', 'ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å‹•ç”»IDã¾ãŸã¯é…ä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return null;
        } catch (error) {
            console.error('ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆIDå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            showMessageBox('APIã‚¨ãƒ©ãƒ¼', 'å‹•ç”»æƒ…å ±å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return null;
        }
    }


    function cleanupOldMessages() {
        // â˜…ä¿®æ­£: UIè¨­å®šã§ã¯ãªãã€å†…éƒ¨çš„ãªä¸Šé™å€¤ã§DOMã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        while (chatContainer.children.length > MAX_DOM_MESSAGES) { 
            chatContainer.removeChild(chatContainer.lastElementChild);
        }
    }

    // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ä»˜ãã®Fetchãƒ©ãƒƒãƒ‘ãƒ¼é–¢æ•°
    async function fetchWithExponentialBackoff(url, maxRetries = 5) {
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    return response;
                }
                
                // 4xx, 5xx ã®ã‚¨ãƒ©ãƒ¼ã¯ãƒªãƒˆãƒ©ã‚¤ã›ãšã«å‡¦ç†ã‚’çµ‚äº†
                if (response.status >= 400) {
                    throw new Error(response.status);
                }
                
            } catch (error) {
                // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©
                if (i === maxRetries - 1) throw error;
            }

            // Exponential Backoff: 2^i * 1000 ms ã®é…å»¶
            const delay = Math.pow(2, i) * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }

    async function fetchChatMessages() {
        if (!liveChatId || !isPolling) return;
    
        const url = `${API_BASE_URL}?liveChatId=${liveChatId}&part=id,snippet,authorDetails&key=${apiKey}&pageToken=${nextPageToken}`;
    
        try {
            const response = await fetch(url); // ãƒãƒƒã‚¯ã‚ªãƒ•ã¯ä¸€æ—¦å‰Šé™¤ã—ã€ç›´æ¥fetch
            const data = await response.json();
    
            // â˜…ä¿®æ­£: APIã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼å¿œç­”ã‚’è©³ç´°ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
            if (data.error) {
                const errorDetails = data.error.errors[0];
                console.error('API Error:', data.error);
                let userMessage = `APIã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ (ç†ç”±: ${errorDetails.reason})ã€‚`;
                if (errorDetails.reason === 'quotaExceeded') {
                    userMessage = 'YouTube APIã®åˆ©ç”¨ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦è©¦ã™ã‹ã€ã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (errorDetails.reason === 'forbidden') {
                     userMessage = 'APIã‚­ãƒ¼ã«å•é¡ŒãŒã‚ã‚‹ã‹ã€ã“ã®ãƒ©ã‚¤ãƒ–é…ä¿¡ã®ãƒãƒ£ãƒƒãƒˆå–å¾—ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
                }
                throw new Error(userMessage); // catchãƒ–ãƒ­ãƒƒã‚¯ã§å‡¦ç†ã™ã‚‹ãŸã‚ã«ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ã‚‹
            }
            
            nextPageToken = data.nextPageToken || '';
            pollingInterval = data.pollingIntervalMillis || 5000;
    
            if (data.items && data.items.length > 0) {
                data.items.forEach(message => {
                    displayMessage(message);
                });
            }
        } catch (error) {
            // â˜…ä¿®æ­£: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤º
            showMessageBox('å–å¾—ã‚¨ãƒ©ãƒ¼', error.message);
            console.error('ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            isPolling = false;
            startButton.textContent = 'å–å¾—é–‹å§‹';
            return;
        }
    
        if (isPolling) {
            setTimeout(fetchChatMessages, pollingInterval);
        }
    }
    
    function generateDummyMessage(type) {
        const commonAuthor = {
            displayName: "ãƒ€ãƒŸãƒ¼ãƒ¦ãƒ¼ã‚¶ãƒ¼",
            displayColor: "#FFC300", 
            isChatOwner: false,
            isChatModerator: false,
            isChatSponsor: false,
        };

        // 4ç¨®é¡ã®ãƒ€ãƒŸãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ©ãƒ³ãƒ€ãƒ ãªé †åºã§ç”Ÿæˆ
        const dummyTypes = ['normal', 'moderator', 'member', 'superchat'];
        let messagesToGenerate = [];

        // å…¨ã¦ã®ã‚¿ã‚¤ãƒ—ã‚’ç”Ÿæˆ
        dummyTypes.forEach(t => {
            let msg;
            const now = Date.now() + Math.random(); 
            switch(t) {
                case 'normal':
                    msg = {
                        id: `dummy-normal-${now}`,
                        snippet: {
                            type: 'textMessageEvent',
                            textMessageDetails: { messageText: "ã“ã‚Œã¯æ™®é€šã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ã™ã€‚ãƒ•ã‚©ãƒ³ãƒˆã‚„è‰²ã®åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆã«ä½¿ã£ã¦ãã ã•ã„ã€‚æœ¬æ–‡ã®é•·ã•ãŒåˆ‡ã‚Œãªã„ã‹ç¢ºèªã—ã¦ã„ã¾ã™ã€‚" }
                        },
                        authorDetails: commonAuthor
                    };
                    break;
                case 'moderator':
                    msg = {
                        id: `dummy-mod-${now}`,
                        snippet: {
                            type: 'textMessageEvent',
                            textMessageDetails: { messageText: "ã€ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãƒ¼ã€‘ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å·¦å´ã®é’ã„ç·šã¨ã‚¢ã‚¤ã‚³ãƒ³ã§å¼·èª¿ã•ã‚Œã¦ã„ã¾ã™ã€‚ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ç¢ºèªã‚’ã—ã¾ã—ã‚‡ã†ã€‚" }
                        },
                        authorDetails: { ...commonAuthor, displayName: "Modå¤ªéƒ", isChatModerator: true }
                    };
                    break;
                case 'member':
                    msg = {
                        id: `dummy-member-${now}`,
                        snippet: {
                            type: 'textMessageEvent',
                            textMessageDetails: { messageText: "ã€ãƒ¡ãƒ³ãƒãƒ¼é™å®šã€‘ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã®èƒŒæ™¯è‰²ï¼ˆæš—ã„é’ï¼‰ã¨ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ç‰¹åˆ¥ãªãƒ‡ã‚¶ã‚¤ãƒ³ã‚’é©ç”¨ã§ãã¾ã™ã€‚" }
                        },
                        authorDetails: { ...commonAuthor, displayName: "ãƒ¡ãƒ³ãƒãƒ¼ç”°ä¸­", isChatSponsor: true }
                    };
                    break;
                case 'superchat':
                    msg = {
                        id: `dummy-sc-${now}`,
                        snippet: {
                            type: 'superChatEvent',
                            displayMessage: "ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ†ã‚¹ãƒˆã«ã‚‚ä½¿ãˆã¾ã™ã€‚",
                            superChatDetails: {
                                amountDisplayString: "Â¥5,000",
                                userComment: "å¿œæ´ã—ã¦ã„ã¾ã™ï¼ã‚³ãƒ¡ãƒ³ãƒˆã¯é•·æ–‡ã«è€ãˆã‚‰ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆä¸­ã§ã™ã€‚ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯éå¸¸ã«é•·ã„ã§ã™ã€‚ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯éå¸¸ã«é•·ã„ã§ã™ã€‚ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯éå¸¸ã«é•·ã„ã§ã™ã€‚"
                            },
                            type: 'superChatEvent'
                        },
                        authorDetails: { ...commonAuthor, displayName: "SCå±±ç”°" }
                    };
                    break;
            }
            messagesToGenerate.push(msg);
        });
        
        // ç”Ÿæˆã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¨ã¦è¡¨ç¤º (displayMessageãŒSCã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹)
        messagesToGenerate.forEach(msg => displayMessage(msg));
    }

    function displaySuperChatInStock(author, amount, comment, id) {
        const scStockHtml = `
            <div class="sc-stock-message" data-id="stock-${id}" style="cursor: pointer;">
                <div class="flex items-center justify-between mb-1 sc-author-container">
                    <span class="sc-author">${author.displayName}</span>
                    <span class="sc-amount">${amount}</span>
                </div>
                ${comment ? `<div class="sc-comment">${comment}</div>` : ''}
            </div>
        `;

        // æœ€æ–°ã®ã‚‚ã®ãŒä¸€ç•ªä¸Šã«æ¥ã‚‹ã‚ˆã†ã« 'afterbegin' ã§æŒ¿å…¥
        // SCã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ã®å¾Œã«è¿½åŠ ã™ã‚‹ãŸã‚ã«ã€ãƒ˜ãƒƒãƒ€ãƒ¼è¦ç´ ï¼ˆæœ€åˆã®è¦ç´ ï¼‰ãŒã‚ã‚Œã°ãã®ç›´å¾Œã«æŒ¿å…¥ã™ã‚‹
        const header = superchatStockContainer.querySelector('div:first-child');
        if (header) {
            header.insertAdjacentHTML('afterend', scStockHtml);
        } else {
            superchatStockContainer.insertAdjacentHTML('afterbegin', scStockHtml);
        }
        
        // ã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ãŒã‚ã‚‹å ´åˆã€æœ€æ–°ã®ã‚‚ã®ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        superchatStockContainer.scrollTop = 0; 
    }


    function displayMessage(message) {
        const snippet = message.snippet;
        const author = message.authorDetails;

        const messageType = snippet.type; 

        let messageText = '';
        let isSuperChat = false;
        let isMember = false;
        let amountString = ''; // SCé‡‘é¡ç”¨
        let userComment = ''; // SCã‚³ãƒ¡ãƒ³ãƒˆç”¨


        if (messageType === 'textMessageEvent') {
            messageText = snippet.textMessageDetails.messageText;
        } else if (messageType === 'superChatEvent') {
            const details = snippet.superChatDetails;
            amountString = details.amountDisplayString;
            userComment = details.userComment || 'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰';
            // SCã®å ´åˆã¯ã€æœ¬æ–‡ã«é‡‘é¡ã‚’å¼·èª¿ã—ã¦è¡¨ç¤ºã™ã‚‹
            // é‡‘é¡ã‚’è‰²åˆ†ã‘ã™ã‚‹ãŸã‚ã€HTMLã‚¿ã‚°ã‚’å«ã‚ã‚‹
            messageText = `<span class="font-bold text-lg text-yellow-300 mr-2">${amountString}</span><br>${userComment}`;
            isSuperChat = true;
            // SCã‚¹ãƒˆãƒƒã‚¯ã«è¿½åŠ 
            displaySuperChatInStock(author, amountString, userComment, message.id);
        } else if (messageType === 'superStickerEvent') {
            const details = snippet.superStickerDetails;
            amountString = details.amountDisplayString;
            userComment = details.userComment || 'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰';
            messageText = `[ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚¹ãƒ†ãƒƒã‚«ãƒ¼: ${amountString}]`;
            isSuperChat = true;
            // SCã‚¹ãƒˆãƒƒã‚¯ã«è¿½åŠ 
            displaySuperChatInStock(author, amountString, messageText, message.id); 
        } else if (messageType === 'newSponsorEvent' || messageType === 'membershipGiftingEvent') {
             messageText = snippet.displayMessage;
             isMember = true;
        } else {
            return;
        }
        
        // â˜…ä¿®æ­£ç‚¹: SCãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆã‹ã‚‰é™¤å¤–ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚â˜…


        let badgeHtml = '';
        if (author.isChatOwner) {
            badgeHtml = `<span class="membership-badge">ğŸ‘‘</span>`;
        } else if (author.isChatModerator) {
            badgeHtml = `<span class="membership-badge">ğŸ”¨</span>`; 
        } else if (author.isChatSponsor) {
            badgeHtml = `<span class="membership-badge">â­</span>`; 
            isMember = true;
        }

        // â˜…ä¿®æ­£: isSuperChatã®å ´åˆã€ä»–ã®ãƒãƒƒã‚¸ã‚ˆã‚Šå„ªå…ˆã—ã¦ã‚³ã‚¤ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
        if (isSuperChat) {
            badgeHtml = `<span class="membership-badge">ğŸª™</span>`;
        }

        const displayMode = chatDisplayModeInput.value;
        
        let classes = ['chat-message'];
        if (author.isChatModerator) classes.push('is-moderator');
        // â˜…ä¿®æ­£ç‚¹: SCã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã‚ˆã†ã«å¾©æ´»
        if (isSuperChat) classes.push('is-superchat'); 
        if (isMember) classes.push('is-member');

        if (displayMode === 'multi') {
            classes.push('multi-line-mode');
        }

        // â˜…ä¿®æ­£: ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç›´æ¥æ›¸ãè¾¼ã‚€ã®ã‚’ã‚„ã‚ã€CSSå¤‰æ•°çµŒç”±ã§é©ç”¨ã™ã‚‹
        const imageUrl = backgroundImageInput.value.trim();


        let dataAttr = '';
        if (imageUrl) {
            dataAttr = `data-bg-image="true"`;
        }

        const styleAttributes = ``; // styleå±æ€§ã¯ç©ºã«ã™ã‚‹

        const messageHtml = `
            <div class="${classes.join(' ')}" data-id="${message.id}" ${dataAttr} ${styleAttributes}>
                <div class="message-content-wrapper">
                    <div class="author-name-container">
                        ${badgeHtml}
                        <span class="author-name">${author.displayName}</span>
                    </div>
                    <span class="message-text">${messageText}</span>
                </div>
            </div>
        `;

        chatContainer.insertAdjacentHTML('afterbegin', messageHtml);
        
        cleanupOldMessages();
        
        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«ç§»å‹•
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    function updateFontSize(target, step) {
        let currentSize;
        let inputElement;

        if (target === 'author') {
            currentSize = authorFontSizeRem;
            inputElement = authorSizeInput;
        } else if (target === 'message') {
            currentSize = messageFontSizeRem;
            inputElement = messageSizeInput;
        } else if (target === 'pinned-author') {
            // â˜…ä¿®æ­£: ãƒ”ãƒ³ç•™ã‚ç”¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æ­£ã—ãå‡¦ç†
            currentSize = pinnedAuthorFontSizeRem;
            inputElement = pinnedAuthorSizeInput;
        } else if (target === 'pinned-message') {
            currentSize = pinnedMessageFontSizeRem;
            inputElement = pinnedMessageSizeInput;
        } else {
            return;
        }

        let newSize = Math.round((currentSize + step) * 10) / 10;
        
        if (newSize < MIN_FONT_SIZE) newSize = MIN_FONT_SIZE;
        if (newSize > MAX_FONT_SIZE) newSize = MAX_FONT_SIZE;

        if (target === 'author') {
            authorFontSizeRem = newSize;
        } else if (target === 'message') {
            messageFontSizeRem = newSize;
        } else if (target === 'pinned-author') {
            pinnedAuthorFontSizeRem = newSize;
        } else if (target === 'pinned-message') {
            pinnedMessageFontSizeRem = newSize;
        }

        inputElement.value = `${newSize.toFixed(1)}rem`;
        
        // â˜…ä¿®æ­£: CSSå¤‰æ•°ã‚’æ›´æ–°ã—ã€å¤‰æ›´ã‚’å³åº§ã«åæ˜ ã•ã›ã‚‹
        initializeLayoutSettings();
    }
    
    // --------------------------------------------------------------------------------
    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šã®åˆæœŸåŒ–ã¨åæ˜  (ãƒ­ãƒ¼ãƒ‰æ™‚ã€ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šæ™‚)
    // --------------------------------------------------------------------------------
    function initializeLayoutSettings() {
        // å…¨ä½“ãƒ•ã‚©ãƒ³ãƒˆ
        const globalFont = globalFontInput.value.trim();
        document.documentElement.style.setProperty('--global-font-family', globalFont || "'Noto Sans JP', 'Inter', sans-serif");
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ•ã‚©ãƒ³ãƒˆ
        const authorFont = authorFontInput.value.trim();
        document.documentElement.style.setProperty('--author-font-family', authorFont);
        
        // ãƒãƒ£ãƒƒãƒˆæœ¬æ–‡ãƒ•ã‚©ãƒ³ãƒˆ
        const messageFont = messageFontInput.value.trim();
        document.documentElement.style.setProperty('--message-font-family', messageFont);

        // â˜…ä¿®æ­£: é€šå¸¸ã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¨è‰²ã‚‚CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§è¨­å®š
        const authorSize = authorSizeInput.value.trim();
        document.documentElement.style.setProperty('--normal-author-font-size', authorSize);
        const authorColor = authorColorInput.value.trim();
        document.documentElement.style.setProperty('--normal-author-color-override', authorColor);
        const messageSize = messageSizeInput.value.trim();
        document.documentElement.style.setProperty('--normal-message-font-size', messageSize);
        const messageColor = messageColorInput.value.trim();
        document.documentElement.style.setProperty('--normal-message-color-override', messageColor);

        // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ³ãƒˆãƒ»è‰²ãƒ»ã‚µã‚¤ã‚ºã‚’åæ˜ 
        document.documentElement.style.setProperty('--pinned-author-font-family', pinnedAuthorFontInput.value.trim());
        document.documentElement.style.setProperty('--pinned-message-font-family', pinnedMessageFontInput.value.trim());

        // â˜…ä¿®æ­£: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã¨è‰²ã‚’CSSã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¨­å®š
        const pinnedAuthorSize = pinnedAuthorSizeInput.value.trim();
        document.documentElement.style.setProperty('--pinned-author-font-size', pinnedAuthorSize);

        const pinnedMessageSize = pinnedMessageSizeInput.value.trim();
        document.documentElement.style.setProperty('--pinned-message-font-size', pinnedMessageSize);

        
        // 2è¡Œè¡¨ç¤ºæ™‚ï¼ˆåˆæœŸå€¤ï¼‰ã®ã¿ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆè¨­å®šã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¡¨ç¤º/éè¡¨ç¤º
        const mode = chatDisplayModeInput.value;
        indentSettingsGroupDiv.classList.toggle('hidden', mode === 'single');
        
        // ğŸ’¡ å‚ç›´ä½ç½®ã®å€¤ã‚’åæ˜  (px)
        const initialAuthorVOffset = parseInt(authorVOffsetRange.value, 10);
        document.documentElement.style.setProperty('--author-vertical-offset-px', `${initialAuthorVOffset}px`);
        authorVOffsetDisplay.textContent = `${initialAuthorVOffset}px`;

        // åå‰ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã®å€¤ã‚’åæ˜ 
        const initialAuthorIndent = parseFloat(authorIndentRange.value).toFixed(1);
        document.documentElement.style.setProperty('--author-indent-rem', `${initialAuthorIndent}rem`);
        authorIndentDisplay.textContent = `${initialAuthorIndent}rem`;

        // æœ¬æ–‡ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã®å€¤ã‚’åæ˜ 
        const initialMessageIndent = parseFloat(messageIndentRange.value).toFixed(1);
        document.documentElement.style.setProperty('--message-indent-rem', `${initialMessageIndent}rem`);
        messageIndentDisplay.textContent = `${initialMessageIndent}rem`;
        
        // åå‰ã¨æœ¬æ–‡ã®ä¸Šä¸‹ã®é–“éš”ã®å€¤ã‚’åæ˜ 
        const initialGap = parseFloat(authorMessageGapRange.value).toFixed(1);
        document.documentElement.style.setProperty('--author-message-gap-rem', `${initialGap}rem`);
        gapDisplay.textContent = `${initialGap}rem`;

        // æ–‡å­—æ•°åˆ¶é™ã®å€¤ã‚’åæ˜ 
        const initialCharLimit = parseInt(charLimitRange.value, 10);
        document.documentElement.style.setProperty('--message-max-chars', `${initialCharLimit}ch`);
        charLimitDisplay.textContent = `${initialCharLimit}æ–‡å­—`;
    }
    
    // --------------------------------------------------------------------------------
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    // --------------------------------------------------------------------------------
    
    // â˜…è¿½åŠ : è¨­å®šä¿å­˜ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼â˜…
    if (saveButton) saveButton.addEventListener('click', saveDesignSettings);

    // ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼
    if (authorSizeUpButton) authorSizeUpButton.addEventListener('click', () => updateFontSize('author', FONT_STEP));
    if (authorSizeDownButton) authorSizeDownButton.addEventListener('click', () => updateFontSize('author', -FONT_STEP));
    if (messageSizeUpButton) messageSizeUpButton.addEventListener('click', () => updateFontSize('message', FONT_STEP));
    if (messageSizeDownButton) messageSizeDownButton.addEventListener('click', () => updateFontSize('message', -FONT_STEP));

    // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºå¤‰æ›´ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼
    if (pinnedAuthorSizeUpButton) pinnedAuthorSizeUpButton.addEventListener('click', () => updateFontSize('pinned-author', FONT_STEP));
    if (pinnedAuthorSizeDownButton) pinnedAuthorSizeDownButton.addEventListener('click', () => updateFontSize('pinned-author', -FONT_STEP));
    if (pinnedMessageSizeUpButton) pinnedMessageSizeUpButton.addEventListener('click', () => updateFontSize('pinned-message', FONT_STEP));
    if (pinnedMessageSizeDownButton) pinnedMessageSizeDownButton.addEventListener('click', () => updateFontSize('pinned-message', -FONT_STEP));

    // ãƒ•ã‚©ãƒ³ãƒˆ/ã‚«ãƒ©ãƒ¼/ç”»åƒURLå¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼ (å³æ™‚åæ˜  + ãƒ€ãƒŸãƒ¼ã§ç¢ºèª)
    [globalFontInput, authorFontInput, messageFontInput, pinnedAuthorFontInput, pinnedMessageFontInput].forEach(input => {
        input.addEventListener('change', () => { initializeLayoutSettings(); generateDummyMessage('normal'); });
    });
    [authorColorInput, messageColorInput, backgroundImageInput].forEach(input => {
        input.addEventListener('input', (e) => {
            // inputã‚¤ãƒ™ãƒ³ãƒˆã¯ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§CSSå¤‰æ•°ã‚’æ›´æ–°
            initializeLayoutSettings();
            generateDummyMessage('normal');
        });
    });
    
    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®šå¤‰æ›´ãƒªã‚¹ãƒŠãƒ¼
    chatDisplayModeInput.addEventListener('change', (e) => {
        initializeLayoutSettings();
        generateDummyMessage('normal');
    });

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç³»ãƒªã‚¹ãƒŠãƒ¼ (inputã‚¤ãƒ™ãƒ³ãƒˆã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°)
    // ğŸ’¡ authorVOffsetRangeã‚’ã“ã“ã«è¿½åŠ 
    [charLimitRange, authorMessageGapRange, authorIndentRange, messageIndentRange, authorVOffsetRange].forEach(range => {
        range.addEventListener('input', (e) => {
            // CSSå¤‰æ•°ã¨è¡¨ç¤ºã‚’æ›´æ–°
            initializeLayoutSettings(); 
            // åæ˜ ç¢ºèª
            generateDummyMessage('normal'); 
        });
    });

    // ãƒ€ãƒŸãƒ¼ãƒ»ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    dummyButton.addEventListener('click', () => {
        // å…¨ã‚¿ã‚¤ãƒ—ã®ãƒ€ãƒŸãƒ¼ã‚’ç”Ÿæˆ
        generateDummyMessage('normal');
    });

    resetButton.addEventListener('click', () => {
        chatContainer.innerHTML = '';
        // SCã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
        superchatStockContainer.innerHTML = `<div class="p-4 border-b border-yellow-500/50">
                <h2 class="text-xl font-bold text-yellow-400">ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆã‚¹ãƒˆãƒƒã‚¯</h2>
            </div>`;
        // â˜…ä¿®æ­£: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã‚‚ã‚¯ãƒªã‚¢
        pinnedChatContainer.innerHTML = '';
        showMessageBox('ãƒªã‚»ãƒƒãƒˆå®Œäº†', 'ã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
    });

    // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã®ã¿ã‚¯ãƒªã‚¢ã™ã‚‹ãƒœã‚¿ãƒ³ã®ãƒªã‚¹ãƒŠãƒ¼
    clearPinnedButton.addEventListener('click', async () => {
        const pinnedMessages = pinnedChatContainer.querySelectorAll('.pinned-message');
        if (pinnedMessages.length === 0) {
            showMessageBox('é€šçŸ¥', 'ã‚¯ãƒªã‚¢ã™ã‚‹ãƒ”ãƒ³ç•™ã‚ãƒãƒ£ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
            return;
        }

        // â˜…ä¿®æ­£: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¾…ã¤ã‚ˆã†ã«å¤‰æ›´
        const animations = Array.from(pinnedMessages).map(msg => {
            return new Promise(resolve => {
                togglePinIcon(msg.dataset.id, false);
                msg.classList.add('hiding');
                msg.addEventListener('animationend', resolve, { once: true });
            });
        });

        await Promise.all(animations);

        pinnedChatContainer.innerHTML = ''; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚¯ãƒªã‚¢
        showMessageBox('ã‚¯ãƒªã‚¢å®Œäº†', 'ãƒ”ãƒ³ç•™ã‚ã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸã€‚');
    });
    startButton.addEventListener('click', async () => {
        if (isPolling) {
            isPolling = false;
            startButton.textContent = 'å–å¾—é–‹å§‹';
            showMessageBox('åœæ­¢ã—ã¾ã—ãŸ', 'ãƒãƒ£ãƒƒãƒˆã®è‡ªå‹•å–å¾—ã‚’åœæ­¢ã—ã¾ã—ãŸã€‚');
            return;
        }
        
        apiKey = apiKeyInput.value.trim();
        const rawInput = videoIdInput.value.trim();

        if (!apiKey || !rawInput) {
            showMessageBox('å…¥åŠ›ä¸è¶³', 'APIã‚­ãƒ¼ã¨å‹•ç”»IDã¾ãŸã¯URLã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }
        
        const videoId = extractVideoId(rawInput);
        
        if (!videoId) {
            showMessageBox('IDæŠ½å‡ºã‚¨ãƒ©ãƒ¼', 'æœ‰åŠ¹ãªYouTubeå‹•ç”»IDã¾ãŸã¯URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        startButton.textContent = 'ãƒ©ã‚¤ãƒ–ãƒãƒ£ãƒƒãƒˆIDå–å¾—ä¸­...';
        startButton.disabled = true;
        
        liveChatId = await fetchLiveChatId(videoId);

        if (liveChatId) {
            isPolling = true;
            nextPageToken = '';
            chatContainer.innerHTML = '';
            // SCã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ã®ãƒ˜ãƒƒãƒ€ãƒ¼ä»¥å¤–ã‚’ã‚¯ãƒªã‚¢
            superchatStockContainer.innerHTML = `<div class="p-4 border-b border-yellow-500/50">
                <h2 class="text-xl font-bold text-yellow-400">ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒ£ãƒƒãƒˆã‚¹ãƒˆãƒƒã‚¯</h2>
            </div>`;
            startButton.textContent = 'ãƒãƒ£ãƒƒãƒˆå–å¾—ä¸­ (ã‚¯ãƒªãƒƒã‚¯ã§åœæ­¢)';
            startButton.disabled = false;
            fetchChatMessages();
        } else {
            startButton.textContent = 'å–å¾—é–‹å§‹';
            startButton.disabled = false;
        }
    });
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã®å‡¦ç†
    document.addEventListener('DOMContentLoaded', () => {
        // localStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
        loadDesignSettings();
        
        // ãƒ€ãƒŸãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºã‚’åˆæœŸåŒ–
        generateDummyMessage('normal');
    });
    
    // â˜…æ–°è¦: ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³UIã®åˆ¶å¾¡
    document.querySelectorAll('.accordion-header').forEach(button => {
        button.addEventListener('click', () => {
            const content = button.nextElementSibling;
            
            button.classList.toggle('active');

            if (content.style.maxHeight) {
                content.style.maxHeight = null;
                content.style.padding = "0 1rem";
            } else {
                // â˜…ä¿®æ­£: é«˜ã•ã‚’è¨ˆç®—ã™ã‚‹å‰ã«ã€å†…éƒ¨è¦ç´ ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
                const indentGroup = content.querySelector('#indent-settings-group');
                if (indentGroup) {
                    indentGroup.classList.toggle('hidden', chatDisplayModeInput.value === 'single');
                }
                // â˜…ä¿®æ­£: scrollHeightã®ä»£ã‚ã‚Šã«ã€ã‚ˆã‚Šæ­£ç¢ºãªgetBoundingClientRect().heightã‚’ä½¿ç”¨
                const innerDiv = content.querySelector('div');
                const contentHeight = innerDiv ? innerDiv.getBoundingClientRect().height : 0;
                content.style.maxHeight = contentHeight + 32 + "px"; // 32pxã¯py-4ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°åˆ†
                content.style.padding = "1rem";
            } 
        });
    });
    // --------------------------------------------------------------------------------
    // â˜…æ–°è¦: ãƒãƒ£ãƒƒãƒˆã®ãƒ”ãƒ³ç•™ã‚æ©Ÿèƒ½
    // --------------------------------------------------------------------------------
    const MAX_PINNED_CHATS = 6;

    // â˜…æ–°è¦: ãƒ”ãƒ³ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ /å‰Šé™¤ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function togglePinIcon(messageId, add = true) {
        // é€šå¸¸ãƒãƒ£ãƒƒãƒˆã¨SCã‚¹ãƒˆãƒƒã‚¯ã®ä¸¡æ–¹ã‹ã‚‰è¦ç´ ã‚’æ¢ã™
        const originalMessage = document.querySelector(`.chat-message[data-id="${messageId}"]`) || document.querySelector(`.sc-stock-message[data-id="${messageId}"]`);
        if (!originalMessage) return;

        const authorContainer = originalMessage.querySelector('.author-name-container') || originalMessage.querySelector('.sc-author-container');
        if (!authorContainer) return;

        if (add) {
            const pinIcon = document.createElement('span');
            pinIcon.className = 'pin-icon';
            pinIcon.textContent = 'ğŸ“Œ';
            authorContainer.insertAdjacentElement('afterbegin', pinIcon);
        } else {
            const existingIcon = authorContainer.querySelector('.pin-icon');
            if (existingIcon) existingIcon.remove();
        }
    }

    // ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç›£è¦– (ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³)
    chatContainer.addEventListener('click', (e) => {
        const chatMessage = e.target.closest('.chat-message');
        if (!chatMessage) return;

        const messageId = chatMessage.dataset.id;
        
        // ã™ã§ã«ãƒ”ãƒ³ç•™ã‚ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
        if (pinnedChatContainer.querySelector(`[data-id="${messageId}"]`)) {
            showMessageBox('é€šçŸ¥', 'ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã™ã§ã«ãƒ”ãƒ³ç•™ã‚ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            return;
        }

        // ãƒ”ãƒ³ç•™ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæœ€å¤§æ•°ã«é”ã—ã¦ã„ãŸã‚‰ã€ä¸€ç•ªå¤ã„ã‚‚ã®ã‚’å‰Šé™¤
        if (pinnedChatContainer.children.length >= MAX_PINNED_CHATS) {
            pinnedChatContainer.removeChild(pinnedChatContainer.lastElementChild);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¤‡è£½ã—ã¦ãƒ”ãƒ³ç•™ã‚ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
        const pinnedMessage = chatMessage.cloneNode(true);
        pinnedMessage.classList.add('pinned-message'); // å¼·èª¿è¡¨ç¤ºç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 

        // â˜…æ–°è¦: ãƒ”ãƒ³ç•™ã‚ã•ã‚ŒãŸSCã‹ã‚‰ã¯é‡‘é¡ã‚’å‰Šé™¤
        if (pinnedMessage.classList.contains('is-superchat')) {
            const messageTextElement = pinnedMessage.querySelector('.message-text');
            if (messageTextElement) {
                const parts = messageTextElement.innerHTML.split('<br>');
                // <br>ã®å¾Œã‚ã«ã‚ã‚‹ã‚³ãƒ¡ãƒ³ãƒˆéƒ¨åˆ†ã ã‘ã‚’æ®‹ã™
                if (parts.length > 1) messageTextElement.innerHTML = parts[1];
            }
        }

        // â˜…ä¿®æ­£: è¤‡è£½ã—ãŸãƒ”ãƒ³ç•™ã‚ç”¨ãƒãƒ£ãƒƒãƒˆã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
        const authorContainer = pinnedMessage.querySelector('.author-name-container');
        if (authorContainer && !authorContainer.querySelector('.pin-icon')) {
            const pinIcon = document.createElement('span');
            pinIcon.className = 'pin-icon';
            pinIcon.textContent = 'ğŸ“Œ';
            authorContainer.insertAdjacentElement('afterbegin', pinIcon);
        }

        pinnedChatContainer.insertAdjacentElement('afterbegin', pinnedMessage);
        togglePinIcon(messageId, true); // å…ƒã®ãƒãƒ£ãƒƒãƒˆã«ã‚‚ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
    });

    // SCã‚¹ãƒˆãƒƒã‚¯ã‚¨ãƒªã‚¢ã§ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç›£è¦– (ãƒ”ãƒ³ç•™ã‚æ©Ÿèƒ½)
    superchatStockContainer.addEventListener('click', (e) => {
        const scStockMessage = e.target.closest('.sc-stock-message');
        if (!scStockMessage) return;

        const messageId = scStockMessage.dataset.id;

        // ã™ã§ã«ãƒ”ãƒ³ç•™ã‚ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
        if (pinnedChatContainer.querySelector(`[data-id="${messageId}"]`)) {
            showMessageBox('é€šçŸ¥', 'ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã™ã§ã«ãƒ”ãƒ³ç•™ã‚ã•ã‚Œã¦ã„ã¾ã™ã€‚');
            return;
        }

        // ãƒ”ãƒ³ç•™ã‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæœ€å¤§æ•°ã«é”ã—ã¦ã„ãŸã‚‰ã€ä¸€ç•ªå¤ã„ã‚‚ã®ã‚’å‰Šé™¤
        if (pinnedChatContainer.children.length >= MAX_PINNED_CHATS) {
            pinnedChatContainer.removeChild(pinnedChatContainer.lastElementChild);
        }

        // ã‚¹ãƒˆãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
        const authorName = scStockMessage.querySelector('.sc-author')?.textContent || 'ä¸æ˜ãªãƒ¦ãƒ¼ã‚¶ãƒ¼';
        const amount = scStockMessage.querySelector('.sc-amount')?.textContent || '';
        const comment = scStockMessage.querySelector('.sc-comment')?.textContent || 'ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ï¼‰';

        // â˜…ä¿®æ­£: ãƒ”ãƒ³ç•™ã‚ç”¨HTMLã§ã¯é‡‘é¡ã‚’å‰Šé™¤ã—ã€ã‚³ãƒ¡ãƒ³ãƒˆã®ã¿ã«ã™ã‚‹
        const messageText = comment;
        
        // .chat-message ã®ã‚¯ãƒ©ã‚¹ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        let classes = ['chat-message', 'is-superchat', 'pinned-message'];
        if (chatDisplayModeInput.value === 'multi') {
            classes.push('multi-line-mode');
        }

        // ãƒ”ãƒ³ç•™ã‚ç”¨ã®HTMLã‚’ä½œæˆ
        const pinnedMessageHtml = `
            <div class="${classes.join(' ')}" data-id="${messageId}">
                <div class="message-content-wrapper">
                    <div class="author-name-container">
                        <span class="pin-icon">ğŸ“Œ</span>
                        <span class="author-name">${authorName.replace('ğŸ“Œ','')}</span>
                    </div>
                    <span class="message-text">${messageText}</span>
                </div>
            </div>
        `;

        // HTMLã‚’DOMè¦ç´ ã«å¤‰æ›ã—ã¦è¿½åŠ 
        const template = document.createElement('template');
        template.innerHTML = pinnedMessageHtml.trim();
        const pinnedMessageNode = template.content.firstChild;
        
        // ãƒ”ãƒ³ç•™ã‚ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
        pinnedChatContainer.insertAdjacentElement('afterbegin', pinnedMessageNode);
        togglePinIcon(messageId, true); // å…ƒã®ãƒãƒ£ãƒƒãƒˆã«ã‚‚ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
    });

    // ãƒ”ãƒ³ç•™ã‚ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ç›£è¦– (ãƒ”ãƒ³ç•™ã‚è§£é™¤)
    pinnedChatContainer.addEventListener('click', (e) => {
        const pinnedMessage = e.target.closest('.pinned-message');
        if (pinnedMessage) {
            togglePinIcon(pinnedMessage.dataset.id, false); // å…ƒã®ãƒãƒ£ãƒƒãƒˆã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‰Šé™¤
            
            // â˜…ä¿®æ­£: ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            pinnedMessage.classList.add('hiding');
            pinnedMessage.addEventListener('animationend', () => {
                pinnedMessage.remove();
            }, { once: true });
        }
    });

</script>
</body>
</html>